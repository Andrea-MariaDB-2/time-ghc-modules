#!/usr/bin/env bash
set -euo pipefail

TSV="$1"
FAILURES="$2"
DUMP_TIMINGS="$3"

REGEX='s/\(.*\) \[\(.*\)\]:.*alloc=\([0-9]*\).*time=\([0-9\.]*\).*/todo-package\t\2\t\1\t\3\t\4/p'
NON_MATCH_REGEX='s/\(.*\) \[\(.*\)\]:.*alloc=\([0-9]*\).*time=\([0-9\.]*\).*/asdf/!p'

sed -n "$REGEX" "$DUMP_TIMINGS" >> "$TSV"
# sed -n "$NON_MATCH_REGEX" "$DUMP_TIMINGS" >> "$FAILURES"

# while read line; do
#   # echo "Saw line: $line"
#   module=$(echo "$line" | sed -n 's/.*\[\(.*\)\]:.*/\1/p')
#   alloc=$(echo "$line" | sed -n 's/.*alloc=\([0-9]*\).*/\1/p')
#   time=$(echo "$line" | sed -n 's/.*time=\([0-9\.]*\).*/\1/p')

#   if [[ -n "$module" && -n "$alloc" && -n "$time" ]]; then
#       echo "unknown\t$module\tunknown\t$alloc\t$time" >> "$TSV"
#   else
#       # TODO: write parse failure
#       echo "Parse failure: $line"
#   fi
# done < "$DUMP_TIMINGS"
